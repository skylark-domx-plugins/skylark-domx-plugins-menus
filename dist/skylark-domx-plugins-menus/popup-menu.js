/**
 * skylark-domx-plugins-menus - The skylark menu plugin library.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-domx/skylark-domx-plugins-menus/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-devices-keyboard/keys","skylark-domx-noder","skylark-domx-styler","skylark-domx-query","skylark-domx-lists","skylark-domx-plugins-base","./menus","./menu"],function(e,t,i,s,n,a,o,u,r){"use strict";var l=r.inherit({klassName:"PopupMenu",pluginName:"lark.menus.popup",delay:300,options:{icons:{submenu:"ui-icon-caret-1-e"},position:{my:"left top",at:"right top"},role:"menu",item:{classes:{base:"ui-menu-item",active:"ui-state-active",disabled:"ui-state-disabled"},selector:"> *"},blur:null,focus:null,select:null},_construct:function(t,s){r.prototype._construct.call(this,t,s),this.element=this.$(),this.activeMenu=this.element,this.mouseHandled=!1,this.lastMousePosition={x:null,y:null},this.element.attr({role:this.options.role,tabIndex:0}),this.listenTo(this.element,{"mousedown .ui-menu-item":function(e){e.preventDefault(),this._activateItem(e)},"click .ui-menu-item":function(e){var t=n(e.target),s=n(i.active());!this.mouseHandled&&t.not(".ui-state-disabled").length&&(this.select(e),e.isPropagationStopped()||(this.mouseHandled=!0),t.has(".ui-menu").length?this.expand(e):!this.element.is(":focus")&&s.closest(".ui-menu").length&&(this.element.trigger("focus",[!0]),this.active&&1===this.active.parents(".ui-menu").length&&clearTimeout(this.timer)))},"mouseenter .ui-menu-item":"_activateItem","mousemove .ui-menu-item":"_activateItem",mouseleave:"collapseAll","mouseleave .ui-menu":"collapseAll",focus:function(e,t){var i=this.active||this._menuItems().first();t||this.focus(e,i)},blur:function(t){this._delay(function(){!e.includes(this.element[0],i.active())&&this.collapseAll(t)})},keydown:"_keydown"}),this.listenTo(n(document),{click:function(e){this._closeOnDocumentClick(e)&&this.collapseAll(e,!0),this.mouseHandled=!1}})},_activateItem:function(e){if(!this.previousFilter&&(e.clientX!==this.lastMousePosition.x||e.clientY!==this.lastMousePosition.y)){this.lastMousePosition={x:e.clientX,y:e.clientY};var t=n(e.target).closest(".ui-menu-item"),i=n(e.currentTarget);t[0]===i[0]&&(i.is(`.${this.options.item.classes.active}`)||(i.siblings().children(`.${this.options.item.classes.active}`).removeClass(this.options.item.classes.active),this.focus(e,i)))}},_destroy:function(){var e=this.element.find(".ui-menu-item").removeAttr("role aria-disabled").children(".ui-menu-item-wrapper").removeUniqueId().removeAttr("tabIndex role aria-haspopup");this.element.removeAttr("aria-activedescendant").find(".ui-menu").addBack().removeAttr("role aria-labelledby aria-expanded aria-hidden aria-disabled tabIndex").removeUniqueId().show(),e.children().each(function(){var e=n(this);e.data("ui-menu-submenu-caret")&&e.remove()})},_keydown:function(e){var i,s,n,a,o=!0;switch(e.keyCode){case t.PAGE_UP:this.previousPage(e);break;case t.PAGE_DOWN:this.nextPage(e);break;case t.HOME:this._move("first","first",e);break;case t.END:this._move("last","last",e);break;case t.UP:this.previous(e);break;case t.DOWN:this.next(e);break;case t.LEFT:this.collapse(e);break;case t.RIGHT:this.active&&!this.active.is(".ui-state-disabled")&&this.expand(e);break;case t.ENTER:case t.SPACE:this._activate(e);break;case t.ESC:this.collapse(e);break;default:o=!1,s=this.previousFilter||"",a=!1,n=e.keyCode>=96&&e.keyCode<=105?(e.keyCode-96).toString():String.fromCharCode(e.keyCode),clearTimeout(this.filterTimer),n===s?a=!0:n=s+n,i=this._filterMenuItems(n),(i=a&&-1!==i.index(this.active.next())?this.active.nextAll(".ui-menu-item"):i).length||(n=String.fromCharCode(e.keyCode),i=this._filterMenuItems(n)),i.length?(this.focus(e,i),this.previousFilter=n,this.filterTimer=this._delay(function(){delete this.previousFilter},1e3)):delete this.previousFilter}o&&e.preventDefault()},_activate:function(e){this.active&&!this.active.is(".ui-state-disabled")&&(this.active.children("[aria-haspopup='true']").length?this.expand(e):this.select(e))},refresh:function(){var t,i,s,a=this,o=this.options.icons.submenu,u=this.element.find(this.options.submenu.selectors.descendant);this.element.toggleClass("ui-menu-icons",!!this.element.find(".ui-icon").length),u.filter(":not(.ui-menu)").hide().attr({role:this.options.role,"aria-hidden":"true","aria-expanded":"false"}).each(function(){var e=n(this),t=e.prev(),i=n("<span>").data("ui-menu-submenu-caret",!0);i.addClass(["ui-menu-icon","ui-icon "+o]),t.attr("aria-haspopup","true").prepend(i),e.attr("aria-labelledby",t.attr("id"))}).addClass(["ui-menu","ui-widget","ui-widget-content","ui-front"]),(t=u.add(this.element).find(this.options.item.selector)).not(".ui-menu-item").each(function(){var e=n(this);a._isDivider(e)&&e.addClass(["ui-menu-divider","ui-widget-content"])}),s=(i=t.not(".ui-menu-item, .ui-menu-divider")).children().not(".ui-menu").attr({tabIndex:-1,role:this._itemRole()}),i.addClass("ui-menu-item"),s.addClass("ui-menu-item-wrapper"),t.filter(".ui-state-disabled").attr("aria-disabled","true"),this.active&&!e.includes(this.element[0],this.active[0])&&this.blur()},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},focus:function(e,t){var i,s;this.blur(e,e&&"focus"===e.type),this._scrollIntoView(t),this.active=t.first(),(s=this.active.children(".ui-menu-item-wrapper")).addClass(this.options.item.classes.active),this.options.role&&this.element.attr("aria-activedescendant",s.attr("id")),this.active.parent().closest(".ui-menu-item").children(".ui-menu-item-wrapper").addClass(this.options.item.classes.active),e&&"keydown"===e.type?this._close():this.timer=this._delay(function(){this._close()},this.delay),(i=t.children(".ui-menu")).length&&e&&/^mouse/.test(e.type)&&this._startOpening(i),this.activeMenu=t.parent(),this.trigger("focus",{item:t})},_scrollIntoView:function(e){var t,i,n,a,o,u;this._hasScroll()&&(t=parseFloat(s.css(this.activeMenu[0],"borderTopWidth"))||0,i=parseFloat(s.css(this.activeMenu[0],"paddingTop"))||0,n=e.offset().top-this.activeMenu.offset().top-t-i,a=this.activeMenu.scrollTop(),o=this.activeMenu.height(),u=e.outerHeight(),n<0?this.activeMenu.scrollTop(a+n):n+u>o&&this.activeMenu.scrollTop(a+n-o+u))},blur:function(e,t){t||clearTimeout(this.timer),this.active&&(this.active.children(".ui-menu-item-wrapper").removeClass(this.options.item.classes.active),this.trigger("blur",{item:this.active}),this.active=null)},_startOpening:function(e){clearTimeout(this.timer),"true"===e.attr("aria-hidden")&&(this.timer=this._delay(function(){this._close(),this._open(e)},this.delay))},_open:function(t){var i=e.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find(".ui-menu").not(t.parents(".ui-menu")).hide().attr("aria-hidden","true"),t.show().removeAttr("aria-hidden").attr("aria-expanded","true").position(i)},collapseAll:function(e,t){clearTimeout(this.timer),this.timer=this._delay(function(){var i=t?this.element:n(e&&e.target).closest(this.element.find(".ui-menu"));i.length||(i=this.element),this._close(i),this.blur(e),i.find(`.${this.options.item.classes.active}`).removeClass(this.options.item.classes.active),this.activeMenu=i},t?0:this.delay)},_close:function(e){e||(e=this.active?this.active.parent():this.element),e.find(".ui-menu").hide().attr("aria-hidden","true").attr("aria-expanded","false")},_closeOnDocumentClick:function(e){return!n(e.target).closest(".ui-menu").length},_isDivider:function(e){return!/[^\-\u2014\u2013\s]/.test(e.text())},collapse:function(e){var t=this.active&&this.active.parent().closest(".ui-menu-item",this.element);t&&t.length&&(this._close(),this.focus(e,t))},expand:function(e){var t=this.active&&this._menuItems(this.active.children(".ui-menu")).first();t&&t.length&&(this._open(t.parent()),this._delay(function(){this.focus(e,t)}))},next:function(e){this._move("next","first",e)},previous:function(e){this._move("prev","last",e)},isFirstItem:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},isLastItem:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},_menuItems:function(e){return(e||this.element).find(this.options.items).filter(".ui-menu-item")},_move:function(e,t,i){var s;this.active&&(s="first"===e||"last"===e?this.active["first"===e?"prevAll":"nextAll"](".ui-menu-item").last():this.active[e+"All"](".ui-menu-item").first()),s&&s.length&&this.active||(s=this._menuItems(this.activeMenu)[t]()),this.focus(i,s)},nextPage:function(e){var t,i,s;this.active?this.isLastItem()||(this._hasScroll()?(i=this.active.offset().top,s=this.element.height(),this.active.nextAll(".ui-menu-item").each(function(){return(t=n(this)).offset().top-i-s<0}),this.focus(e,t)):this.focus(e,this._menuItems(this.activeMenu)[this.active?"last":"first"]())):this.next(e)},previousPage:function(e){var t,i,s;this.active?this.isFirstItem()||(this._hasScroll()?(i=this.active.offset().top,s=this.element.height(),this.active.prevAll(".ui-menu-item").each(function(){return(t=n(this)).offset().top-i+s>0}),this.focus(e,t)):this.focus(e,this._menuItems(this.activeMenu).first())):this.next(e)},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")},select:function(e){this.active=this.active||n(e.target).closest(".ui-menu-item");var t={item:this.active};this.active.has(".ui-menu").length||this.collapseAll(e,!0),this.trigger("select",t)},_filterMenuItems:function(t){var i=t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),s=new RegExp("^"+i,"i");return this.activeMenu.find(this.options.items).filter(".ui-menu-item").filter(function(){return s.test(e.trim(n(this).children(".ui-menu-item-wrapper").text()))})}});return o.register(l),u.PopupMenu=l});
//# sourceMappingURL=sourcemaps/popup-menu.js.map
