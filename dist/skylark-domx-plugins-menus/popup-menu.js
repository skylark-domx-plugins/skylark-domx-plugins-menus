/**
 * skylark-domx-plugins-menus - The skylark menu plugin library.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-domx/skylark-domx-plugins-menus/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-devices-keyboard/keys","skylark-domx-noder","skylark-domx-styler","skylark-domx-query","skylark-domx-lists","skylark-domx-plugins-base","skylark-domx-plugins-popups/popups","./menus","./menu"],function(s,a,i,n,o,t,e,l,c,h){"use strict";var r=h.inherit({klassName:"PopupMenu",pluginName:"lark.menus.popup",delay:300,options:{icons:{submenu:"ui-icon-caret-1-e"},position:{my:"left top",at:"right top"},role:"menu",item:{classes:{base:"menu-item",active:"active",disabled:"disabled",wrapper:"menu-item-wrapper"},selector:"> *"},blur:null,focus:null,select:null},_construct:function(t,e){h.prototype._construct.call(this,t,e),this.element=this.$(),this.activeMenu=this.element,this.mouseHandled=!1,this.lastMousePosition={x:null,y:null},this.element.attr({role:this.options.role,tabIndex:0}),this.listenTo(this.element,{mousedown:function(t){t.preventDefault(),this._activateItem(t)},click:function(t){var e=o(t.target),s=o(i.active());!this.mouseHandled&&e.not("."+this.options.item.classes.disable).length&&(this.select(t),t.isPropagationStopped()||(this.mouseHandled=!0),e.has("."+this.options.submenu.classes.base).length?this.expand(t):!this.element.is(":focus")&&s.closest("."+this.options.submenu.classes.base).length&&(this.element.trigger("focus",[!0]),this.active)&&1===this.active.parents("."+this.options.submenu.classes.base).length&&clearTimeout(this.timer))},mouseenter:"_activateItem",mousemove:"_activateItem"},"."+this.options.item.classes.base),this.listenTo(this.element,{mouseleave:"collapseAll",focus:function(t,e){var s=this.active||this._menuItems().first();e||this.focus(t,s)},blur:function(t){this._delay(function(){i.contains(this.element[0],i.active())||this.collapseAll(t)})},keydown:"_keydown"}),this.listenTo(this.element,"mouseleave","."+this.options.submenu.classes.base,"collapseAll"),this.listenTo(o(document),{click:function(t){this._closeOnDocumentClick(t)&&this.collapseAll(t,!0),this.mouseHandled=!1}})},_activateItem:function(t){var e,s;this.previousFilter||t.clientX===this.lastMousePosition.x&&t.clientY===this.lastMousePosition.y||(this.lastMousePosition={x:t.clientX,y:t.clientY},e=o(t.target).closest("."+this.options.item.classes.base),s=o(t.currentTarget),e[0]!==s[0])||s.is("."+this.options.item.classes.active)||(s.siblings().children("."+this.options.item.classes.active).removeClass(this.options.item.classes.active),this.focus(t,s))},_keydown:function(t){var e,s,i,n=!0;switch(t.keyCode){case a.PAGE_UP:this.previousPage(t);break;case a.PAGE_DOWN:this.nextPage(t);break;case a.HOME:this._move("first","first",t);break;case a.END:this._move("last","last",t);break;case a.UP:this.previous(t);break;case a.DOWN:this.next(t);break;case a.LEFT:this.collapse(t);break;case a.RIGHT:this.active&&!this.active.is("."+this.options.item.classes.disabled)&&this.expand(t);break;case a.ENTER:case a.SPACE:this._activate(t);break;case a.ESC:this.collapse(t);break;default:e=this.previousFilter||"",i=n=!1,s=96<=t.keyCode&&t.keyCode<=105?(t.keyCode-96).toString():String.fromCharCode(t.keyCode),clearTimeout(this.filterTimer),s===e?i=!0:s=e+s,e=this._filterMenuItems(s),(e=i&&-1!==e.index(this.active.next())?this.active.nextAll("."+this.options.item.classes.base):e).length||(s=String.fromCharCode(t.keyCode),e=this._filterMenuItems(s)),e.length?(this.focus(t,e),this.previousFilter=s,this.filterTimer=this._delay(function(){delete this.previousFilter},1e3)):delete this.previousFilter}n&&t.preventDefault()},_activate:function(t){this.active&&!this.active.is("."+this.options.item.classes.disabled)&&(this.active.children("[aria-haspopup='true']").length?this.expand(t):this.select(t))},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},focus:function(t,e){var s;this.blur(t,t&&"focus"===t.type),this._scrollIntoView(e),this.active=e.first(),(s=this.active.children("."+this.options.item.classes.wrapper)).addClass(this.options.item.classes.active),this.options.role&&this.element.attr("aria-activedescendant",s.attr("id")),this.active.parent().closest("."+this.options.item.classes.base).children("."+this.options.item.classes.wrapper).addClass(this.options.item.classes.active),t&&"keydown"===t.type?this._close():this.timer=this._delay(function(){this._close()},this.delay),(s=e.children("."+this.options.submenu.classes.base)).length&&t&&/^mouse/.test(t.type)&&this._startOpening(s),this.activeMenu=e.parent(),this.trigger("focus",{item:e})},_scrollIntoView:function(t){var e,s,i;this._hasScroll()&&(e=parseFloat(n.css(this.activeMenu[0],"borderTopWidth"))||0,s=parseFloat(n.css(this.activeMenu[0],"paddingTop"))||0,e=t.offset().top-this.activeMenu.offset().top-e-s,s=this.activeMenu.scrollTop(),i=this.activeMenu.height(),t=t.outerHeight(),e<0?this.activeMenu.scrollTop(s+e):i<e+t&&this.activeMenu.scrollTop(s+e-i+t))},blur:function(t,e){e||clearTimeout(this.timer),this.active&&(this.active.children("."+this.options.item.classes.wrapper).removeClass(this.options.item.classes.active),this.trigger("blur",{item:this.active}),this.active=null)},_startOpening:function(t){clearTimeout(this.timer),this.timer=this._delay(function(){this._close(),this._open(t)},this.delay)},_open:function(t){var e=s.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find("."+this.options.submenu.classes.base).not(t.parents("."+this.options.submenu.classes.base)).hide().attr("aria-hidden","true"),l.open(t.attr("aria-expanded","true"),{position:e})},collapseAll:function(e,s){clearTimeout(this.timer),this.timer=this._delay(function(){var t=s?this.element:o(e&&e.target).closest(this.element.find("."+this.options.submenu.classes.base));t.length||(t=this.element),this._close(t),this.blur(e),t.find("."+this.options.item.classes.active).removeClass(this.options.item.classes.active),this.activeMenu=t},s?0:this.delay)},_close:function(t){t=t||(this.active?this.active.parent():this.element),l.close(t.find("."+this.options.submenu.classes.base).attr("aria-expanded","false"))},_closeOnDocumentClick:function(t){return!o(t.target).closest("."+this.options.submenu.classes.base).length},_isDivider:function(t){return!/[^\-\u2014\u2013\s]/.test(t.text())},collapse:function(t){var e=this.active&&this.active.parent().closest("."+this.options.item.classes.base,this.element);e&&e.length&&(this._close(),this.focus(t,e))},expand:function(t){var e=this.active&&this._menuItems(this.active.children("."+this.options.submenu.classes.base)).first();e&&e.length&&(this._open(e.parent()),this._delay(function(){this.focus(t,e)}))},next:function(t){this._move("next","first",t)},previous:function(t){this._move("prev","last",t)},isFirstItem:function(){return this.active&&!this.active.prevAll("."+this.options.item.classes.base).length},isLastItem:function(){return this.active&&!this.active.nextAll("."+this.options.item.classes.base).length},_menuItems:function(t){return(t||this.element).find(this.options.items).filter("."+this.options.item.classes.base)},_move:function(t,e,s){var i;(i=this.active?"first"===t||"last"===t?this.active["first"===t?"prevAll":"nextAll"]("."+this.options.item.classes.base).last():this.active[t+"All"]("."+this.options.item.classes.base).first():i)&&i.length&&this.active||(i=this._menuItems(this.activeMenu)[e]()),this.focus(s,i)},nextPage:function(t){var e,s,i;this.active?this.isLastItem()||(this._hasScroll()?(s=this.active.offset().top,i=this.element.height(),this.active.nextAll("."+this.options.item.classes.base).each(function(){return(e=o(this)).offset().top-s-i<0}),this.focus(t,e)):this.focus(t,this._menuItems(this.activeMenu)[this.active?"last":"first"]())):this.next(t)},previousPage:function(t){var e,s,i;this.active?this.isFirstItem()||(this._hasScroll()?(s=this.active.offset().top,i=this.element.height(),this.active.prevAll("."+this.options.item.classes.base).each(function(){return 0<(e=o(this)).offset().top-s+i}),this.focus(t,e)):this.focus(t,this._menuItems(this.activeMenu).first())):this.next(t)},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")},select:function(t){this.active=this.active||o(t.target).closest("."+this.options.item.classes.base);var e={item:this.active};this.active.has("."+this.options.submenu.classes.base).length||this.collapseAll(t,!0),this.trigger("select",e)},_filterMenuItems:function(t){var t=t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),e=new RegExp("^"+t,"i");return this.activeMenu.find(this.options.items).filter("."+this.options.item.classes.base).filter(function(){return e.test(s.trim(o(this).children("."+this.options.item.classes.wrapper).text()))})}});return e.register(r),c.PopupMenu=r});
//# sourceMappingURL=sourcemaps/popup-menu.js.map
